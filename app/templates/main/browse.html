{% extends "base.html" %}

{% block head %}
    {{ super() }}
    <style>
        .ui-autocomplete-loading {
            background: white url({{ url_for('static', filename='loading.gif') }}) right center no-repeat;
        }

        line {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        circle {
            stroke: #fff;
            stroke-width: 1.5px;
        }

        table {
            display: flex;
            flex-flow: column;
            width: 100%;
        }

        thead {
            flex: 0 0 auto;
        }

        tbody {
            max-height: 400px;
            flex: 1 1 auto;
            display: block;
            overflow-y: scroll;
            overflow-x: hidden;
        }

        tr {
            width: 100%;
            display: table;
            table-layout: fixed;
        }

    </style>
{% endblock %}

{% block app_content %}
    <h1>Graph Browser</h1>
    <div>
        <br>
        <div id="resource-status" class="row">
            <div class="col-md-12">
                <input id="search" type="text" class="form-control" placeholder="Input search term">
            </div>
        </div>
        <br>
        <div id="nodes_display" class="row">
            <div id="toolbox" class="col-md-4">
            </div>
            <div id="canvas" class="col-md-8">
            </div>
        </div>
        <div id="articles_display" class="row">
            <div class="panel panel-primary">
                <div class="panel-heading"><h3>Mentioned in</h3></div>
                <div id="struct_panel_body" class="panel-body table-responsive">
                    <table class="table table-striped" id="articleTable">
                        <thead>
                        <tr>
                            <th style="width: 10%">PMID</th>
                            <th style="width: 70%">Title</th>
                            <th style="width: 20%">Journal</th>
                        </tr>
                        </thead>
                    </table>
                </div>
            </div>

        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script type=text/javascript>
        let width = 500,
            height = 500;
        let nodeSize = 20;

        let nodes = []
        let links = []

        const svg = d3.create("svg")
            .property("value", {nodes: [], links: []})
            .attr("viewBox", [-width / 2, -height / 2, width, height]);

        svg.append('defs').append('marker')
            .attr("id", "arrow")
            .attr("viewBox", '-0 -5 10 10')
            .attr("refX", 13)
            .attr("refY", 0)
            .attr("markerWidth", 13)
            .attr("markerHeight", 8)
            .attr("orient", 'auto')
            .attr("xoverflow", 'visible')
            .append('svg:path')
            .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
            .attr('fill', '#999')
            .style('stroke', 'none');

        d3.select("#canvas").append(() => svg.node());

        let simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(function (d) {
                return d.id;
            }))
            .force("charge", d3.forceManyBody().strength(-4000))
            //.force("center", d3.forceCenter(width / 2, height / 2))
            .force("x", d3.forceX())
            .force("y", d3.forceY())
            .on("tick", ticked);

        const dragger = d3.drag(simulation)
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended);

        let link = svg.append("g")
            .attr("stroke", "#999")
            .attr("opacity", "0.9")
            .selectAll("line");

        let edgepaths = svg.selectAll(".edgepath");
        let edgelabels = svg.selectAll(".edgelabel")

        let node = svg.append("g")
            .selectAll(".node");

        function ticked() {
            link.each(function (d) {
                deltaX = d.target.x - d.source.x;
                deltaY = d.target.y - d.source.y;

                pythag = Math.sqrt((deltaX * deltaX) + (deltaY * deltaY));

                adjustedX = d.target.x - ((deltaX * nodeSize) / pythag);
                adjustedY = d.target.y - ((deltaY * nodeSize) / pythag);

                d3.select(this)
                    .attr("x1", d.source.x)
                    .attr("y1", d.source.y)
                    .attr("x2", adjustedX)
                    .attr("y2", adjustedY);

            });

            node
                .attr("transform", function (d) {
                    return "translate(" + d.x + "," + d.y + ")";
                })

            edgepaths.attr('d', function (d) {
                return 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y;
            });

            edgelabels.attr('transform', function (d) {
                if (d.target.x < d.source.x) {
                    let bbox = this.getBBox();
                    rx = bbox.x + bbox.width / 2;
                    ry = bbox.y + bbox.height / 2;
                    return 'rotate(180 ' + rx + ' ' + ry + ')';
                }
                return 'rotate(0)';
            });
        }

        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }

        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }

        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }

        function createForceNetwork(in_nodes, edges) {

            nodes = in_nodes;
            links = edges;

            link = link
                .data(links)
                .join(enter => enter.append("line")
                        .attr("stroke-width", "1px")
                        .attr('marker-end', "url(#arrow"),
                    update => update,
                    exit => exit.remove());

            link.append("title")
                .text(function (d) {
                    return d.type;
                });

            edgepaths = edgepaths.data(links)
                .join(
                    enter => enter.append('path')
                        .attr("class", "edgepath")
                        .attr("fill-opacity", 0)
                        .attr('stroke-opacity', 0)
                        .attr("id", function (d, i) {
                            return 'edgepath' + i
                        })
                        .style("pointer-events", "none"),
                    update => update,
                    exit => exit.remove()
                );


            edgelabels = edgelabels.data(links)
                .join(
                    enter => enter.append('text')
                        .style("pointer-events", "none")
                        .attr("class", "edgelabel")
                        .attr("font-size", 10)
                        .attr('fill', '#aaa')
                        .attr("id", function (d, i) {
                            return 'edgelabel' + i
                        }),
                    update => update,
                    exit => exit.remove()
                );

            svg.selectAll(".edgelabel_text").remove();

            edgelabels.append('textPath')
                .attr("class", "edgelabel_text")
                .attr('xlink:href', function (d, i) {
                    return '#edgepath' + i
                })
                .style("text-anchor", "middle")
                .style("pointer-events", "none")
                .attr("startOffset", "50%")
                .text(function (d) {
                    return d.type
                });

            node = node
                .data(nodes)
                .join(
                    enter => enter.append("g")
                        .attr("class", "node")
                        .call(dragger),
                    update => update,
                    exit => exit.remove()
                );

            svg.selectAll(".node_circle").remove();

            node.append("circle")
                .attr("class", "node_circle")
                .attr("r", nodeSize)
                .attr("fill", "#66CCCC")
                .attr("fill-opacity", 0.9);

            svg.selectAll(".node_text").remove();

            node.append("text")
                .attr("class", "node_text")
                .style("text-anchor", "middle")
                .attr("font-size", 11)
                .text(function (d) {
                    return d.label;
                });

            simulation.nodes(nodes);

            simulation.force("link").links(links);
            simulation.alpha(1).restart();

            svg.property("value", {
                nodes: nodes.map(d => ({id: d.index})),
                links: links.map(d => ({source: d.source.index, target: d.target.index}))
            });
        }

        function plot(node_label) {
            $.post("{{url_for('main.graph')}}", {label: node_label})
                .done(function (data) {
                        createForceNetwork(data.nodes, data.links);
                    }
                );
        }

        function add_articles(node_label) {
            $.post("{{url_for('main.articles')}}", {label: node_label})
                .done(function (data) {
                    function addArticleRow(pmid, title, journal) {
                        // Get a reference to the table
                        let tbody = document.getElementById("articleTableBody");

                        let newRow = tbody.insertRow(-1);

                        let pmidCell = newRow.insertCell(0);
                        pmidCell.setAttribute("style", "width: 10%");
                        let pmidText = document.createTextNode(pmid);
                        pmidCell.appendChild(pmidText);

                        let titleCell = newRow.insertCell(1);
                        titleCell.setAttribute("style", "width: 70%");
                        let titleText = document.createTextNode(title);
                        titleCell.appendChild(titleText);

                        let journalCell = newRow.insertCell(2);
                        journalCell.setAttribute("style", "width: 15%");
                        let journalText = document.createTextNode(journal);
                        journalCell.appendChild(journalText);

                        let linkCell = newRow.insertCell(3);
                        linkCell.setAttribute("style", "width: 5%");
                        let link = document.createElement('a');
                        link.href = 'https://pubmed.ncbi.nlm.nih.gov/' + pmid;
                        link.setAttribute("target", "_blank");
                        let span = document.createElement("SPAN");
                        span.setAttribute("class", "glyphicon glyphicon-link");
                        link.appendChild(span);
                        linkCell.appendChild(link);
                    }

                    let prevBody = document.getElementById("articleTableBody");
                    if (prevBody) {
                        prevBody.remove();
                    }
                    let tableRef = document.getElementById("articleTable");
                    let newBody = document.createElement("TBODY");
                    newBody.setAttribute("id", "articleTableBody");
                    tableRef.appendChild(newBody);
                    data.forEach(element => addArticleRow(element.pmid, element.title, element.journal));
                });
        }

        $("#search").autocomplete({
            source: function (request, response) {
                $.getJSON("{{url_for('main.autocomplete')}}", {
                    q: request.term, // in flask, "q" will be the argument to look for using request.args
                }, function (data) {
                    response(data.matching_results); // matching_results from jsonify
                });
            },
            minLength: 2,
            select: function (event, ui) {
                plot(ui.item.value);
                add_articles(ui.item.value);
            }
        });


    </script>
{% endblock %}