{% extends "base.html" %}

{% block head %}
    {{ super() }}
    <style>
        .ui-autocomplete-loading {
            background: white url({{ url_for('static', filename='loading.gif') }}) right center no-repeat;
        }

        .links line {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        .nodes circle {
            stroke: #fff;
            stroke-width: 1.5px;
        }

        table {
            display: flex;
            flex-flow: column;
            width: 100%;
        }

        thead {
            flex: 0 0 auto;
        }

        tbody {
            max-height: 400px;
            flex: 1 1 auto;
            display: block;
            overflow-y: scroll;
            overflow-x: hidden;
        }

        tr {
            width: 100%;
            display: table;
            table-layout: fixed;
        }

    </style>
{% endblock %}

{% block app_content %}
    <h1>Graph Browser</h1>
    <div>
        <br>
        <div id="resource-status" class="row">
            <div class="col-md-12">
                <input id="search" type="text" class="form-control" placeholder="Input search term">
            </div>
        </div>
        <br>
        <div id="nodes_display" class="row">
            <div id="toolbox" class="col-md-4">
            </div>
            <div id="canvas" class="col-md-8">
            </div>
        </div>
        <div id="articles_display" class="row">
            <div class="panel panel-primary">
                <div class="panel-heading"><h3>Mentioned in</h3></div>
                <div id="struct_panel_body" class="panel-body table-responsive">
                    <table class="table table-striped" id="articleTable">
                        <thead>
                        <tr>
                            <th style="width: 10%">PMID</th>
                            <th style="width: 70%">Title</th>
                            <th style="width: 20%">Journal</th>
                        </tr>
                        </thead>
                    </table>
                </div>
            </div>

        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script type=text/javascript>
        let margin = {top: 10, right: 30, bottom: 30, left: 40},
            width = 500 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        let svg = d3.select("#canvas")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        let nodeSize = 20;

        svg.append('defs').append('marker')
            .attr("id", "arrow")
            .attr("viewBox", '-0 -5 10 10')
            .attr("refX", 13)
            .attr("refY", 0)
            .attr("markerWidth", 13)
            .attr("markerHeight", 8)
            .attr("orient", 'auto')
            .attr("xoverflow", 'visible')
            .append('svg:path')
            .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
            .attr('fill', '#999')
            .style('stroke', 'none');

        let simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(function (d) {
                return d.id;
            }))
            .force("charge", d3.forceManyBody().strength(-4000))
            .force("center", d3.forceCenter(width / 2, height / 2));

        function createForceNetwork(nodes, edges) {

            svg.selectAll("g.links").remove();
            svg.selectAll(".edgepath").remove();
            svg.selectAll(".edgelabel").remove();
            svg.selectAll("g.nodes").remove();
            simulation.restart();

            let link = svg.append("g")
                .attr("class", "links")
                .selectAll("line")
                .data(edges)
                .enter().append("line")
                .attr("stroke-width", "1px")
                .attr('marker-end', "url(#arrow");

            link.append("title")
                .text(function (d) {
                    return d.type;
                });

            let edgepaths = svg.selectAll(".edgepath")
                .data(edges)
                .enter()
                .append('path')
                .attr("class", "edgepath")
                .attr("fill-opacity", 0)
                .attr('stroke-opacity', 0)
                .attr("id", function (d, i) {
                    return 'edgepath' + i
                })
                .style("pointer-events", "none");

            let edgelabels = svg.selectAll(".edgelabel")
                .data(edges)
                .enter()
                .append('text')
                .style("pointer-events", "none")
                .attr("class", "edgelabel")
                .attr("font-size", 10)
                .attr('fill', '#aaa')
                .attr("id", function (d, i) {
                    return 'edgelabel' + i
                });

            edgelabels.append('textPath')
                .attr('xlink:href', function (d, i) {
                    return '#edgepath' + i
                })
                .style("text-anchor", "middle")
                .style("pointer-events", "none")
                .attr("startOffset", "50%")
                .text(function (d) {
                    return d.type
                });

            let node = svg.append("g")
                .attr("class", "nodes")
                .selectAll("g")
                .data(nodes)
                .enter().append("g")

            let circles = node.append("circle")
                .attr("r", nodeSize)
                .attr("fill", "#66CCCC")
                .attr("fill-opacity", 0.9)
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended)
                );


            let labels = node.append("text")
                .style("text-anchor", "middle")
                .text(function (d) {
                    return d.label;
                });

            simulation.nodes(nodes).on("tick", ticked);

            simulation.force("link").links(edges);

            function ticked() {
                link.each(function (d) {
                    deltaX = d.target.x - d.source.x;
                    deltaY = d.target.y - d.source.y;

                    pythag = Math.sqrt((deltaX * deltaX) + (deltaY * deltaY));

                    adjustedX = d.target.x - ((deltaX * nodeSize) / pythag);
                    adjustedY = d.target.y - ((deltaY * nodeSize) / pythag);

                    d3.select(this)
                        .attr("x1", d.source.x)
                        .attr("y1", d.source.y)
                        .attr("x2", adjustedX)
                        .attr("y2", adjustedY);

                });

                node
                    .attr("transform", function (d) {
                        return "translate(" + d.x + "," + d.y + ")";
                    })

                edgepaths.attr('d', function (d) {
                    return 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y;
                });

                edgelabels.attr('transform', function (d) {
                    if (d.target.x < d.source.x) {
                        let bbox = this.getBBox();
                        rx = bbox.x + bbox.width / 2;
                        ry = bbox.y + bbox.height / 2;
                        return 'rotate(180 ' + rx + ' ' + ry + ')';
                    }
                    return 'rotate(0)';
                });
            }

            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }
        }

        function plot(node_label) {
            $.post("{{url_for('main.graph')}}", {label: node_label})
                .done(function (data) {
                        createForceNetwork(data.nodes, data.links);
                    }
                );
        }

        function add_articles(node_label) {
            $.post("{{url_for('main.articles')}}", {label: node_label})
                .done(function (data) {
                    function addArticleRow(pmid, title, journal) {
                        // Get a reference to the table
                        let tbody = document.getElementById("articleTableBody");

                        let newRow = tbody.insertRow(-1);

                        let pmidCell = newRow.insertCell(0);
                        pmidCell.setAttribute("style", "width: 10%");
                        let pmidText = document.createTextNode(pmid);
                        pmidCell.appendChild(pmidText);

                        let titleCell = newRow.insertCell(1);
                        titleCell.setAttribute("style", "width: 70%");
                        let titleText = document.createTextNode(title);
                        titleCell.appendChild(titleText);

                        let journalCell = newRow.insertCell(2);
                        journalCell.setAttribute("style", "width: 20%");
                        let journalText = document.createTextNode(journal);
                        journalCell.appendChild(journalText);
                    }

                    let prevBody = document.getElementById("articleTableBody");
                    if (prevBody) {
                        prevBody.remove();
                    }
                    let tableRef = document.getElementById("articleTable");
                    let newBody = document.createElement("TBODY");
                    newBody.setAttribute("id", "articleTableBody");
                    tableRef.appendChild(newBody);
                    data.forEach(element => addArticleRow(element.pmid, element.title, element.journal));
                });
        }

        $("#search").autocomplete({
            source: function (request, response) {
                $.getJSON("{{url_for('main.autocomplete')}}", {
                    q: request.term, // in flask, "q" will be the argument to look for using request.args
                }, function (data) {
                    response(data.matching_results); // matching_results from jsonify
                });
            },
            minLength: 2,
            select: function (event, ui) {
                plot(ui.item.value);
                add_articles(ui.item.value);
            }
        });


    </script>
{% endblock %}